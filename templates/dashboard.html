<!DOCTYPE html>
<html>
<head>
    <title>XRP Forensics Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.6/dist/dist/vis-network.min.css" rel="stylesheet">
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.6/dist/vis-network.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-data/7.1.6/vis-data.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    
    <style>
        .metric-card {
            @apply bg-white rounded-lg shadow p-6;
        }
        .chart-container {
            @apply bg-white rounded-lg shadow p-4 mb-6;
            height: 300px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold text-blue-600">XRP Forensics</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('logout') }}" class="text-gray-600 hover:text-gray-900">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Search Section -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-4">Transaction Analysis</h2>
                <div class="flex gap-4">
                    <input type="text" id="addressInput" 
                           class="flex-1 p-2 border rounded"
                           placeholder="Enter transaction hash">
                    <button onclick="analyzeAddress()" 
                            class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                        Analyze
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading & Error States -->
        <div id="loadingIndicator" class="hidden">
            <div class="flex justify-center items-center p-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <span class="ml-2">Analyzing...</span>
            </div>
        </div>
        <div id="errorMessage" class="hidden bg-red-100 text-red-700 p-4 rounded mb-4"></div>

        <!-- Results Container -->
        <div id="resultsContainer" class="hidden">
            <!-- Metrics Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="metric-card">
                    <h3 class="text-gray-500">Transaction Volume</h3>
                    <p class="text-2xl font-bold" id="txVolume">-</p>
                    <p class="text-sm text-gray-500">Last 24 hours</p>
                </div>
                <div class="metric-card">
                    <h3 class="text-gray-500">Risk Assessment</h3>
                    <p class="text-2xl font-bold" id="riskScore">-</p>
                    <p class="text-sm text-gray-500">Current Assessment</p>
                </div>
                <div class="metric-card">
                    <h3 class="text-gray-500">Connected Addresses</h3>
                    <p class="text-2xl font-bold" id="connectedAddresses">-</p>
                    <p class="text-sm text-gray-500">Direct Connections</p>
                </div>
            </div>

            <!-- Analysis Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Transaction Network -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4">Transaction Network</h2>
                    <div id="network" style="height: 400px;"></div>
                </div>

                <!-- Transaction Timeline -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4">Transaction Timeline</h2>
                    <div id="timeline" class="space-y-4"></div>
                </div>

                <!-- Risk Analysis -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4">Risk Analysis</h2>
                    <div id="riskFactors" class="space-y-4"></div>
                </div>

                <!-- Transaction Patterns -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4">Transaction Patterns</h2>
                    <div id="patterns" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAddress = '';

        async function analyzeAddress() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) {
                showError('Please enter a transaction hash');
                return;
            }

            hideError();
            showLoading(true);
            hideResults();
            currentAddress = address;

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ address: address })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                updateDashboard(data);
                showResults();
            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        function updateDashboard(data) {
            const tx = data.transactions[0] || {};

            // Update metrics
            document.getElementById('txVolume').textContent = tx.amount ? `${tx.amount} XRP` : '0 XRP';
            document.getElementById('riskScore').textContent = `${data.risk_assessment?.risk_score || 0}/100`;
            document.getElementById('connectedAddresses').textContent = 
                (tx.sender && tx.destination) ? '2' : (tx.sender || tx.destination ? '1' : '0');

            // Update timeline
            updateTimeline(tx);

            // Update network visualization
            updateNetworkVisualization(tx);

            // Update risk analysis
            updateRiskAnalysis(data.risk_assessment);

            // Update patterns
            updateTransactionPatterns(tx);
        }

        function updateTimeline(tx) {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = `
                <div class="border-l-2 border-blue-500 pl-4">
                    <div class="text-sm text-gray-500">${new Date(tx.date).toLocaleString()}</div>
                    <div class="font-medium">${tx.type}</div>
                    <div class="mt-1 text-sm">
                        <div>From: ${truncateAddress(tx.sender)}</div>
                        ${tx.destination ? `<div>To: ${truncateAddress(tx.destination)}</div>` : ''}
                        <div>Amount: ${tx.amount || '0'} XRP</div>
                        <div>Fee: ${tx.fee || '0'} XRP</div>
                    </div>
                </div>
            `;
        }

        function updateNetworkVisualization(tx) {
            const container = document.getElementById('network');
            
            const nodes = new vis.DataSet([
                { id: 1, label: truncateAddress(tx.sender), color: '#4CAF50' },
                { id: 2, label: truncateAddress(tx.destination), color: '#2196F3' }
            ]);

            const edges = new vis.DataSet([
                { from: 1, to: 2, arrows: 'to', title: `${tx.amount || '0'} XRP` }
            ]);

            const options = {
                nodes: {
                    shape: 'dot',
                    size: 30,
                    font: { size: 14 },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    width: 2,
                    smooth: { type: 'continuous' },
                    shadow: true
                },
                physics: {
                    stabilization: true,
                    barnesHut: {
                        gravitationalConstant: -80000,
                        springConstant: 0.001,
                        springLength: 200
                    }
                }
            };

            new vis.Network(container, { nodes, edges }, options);
        }

        function updateRiskAnalysis(riskData) {
            const riskFactors = document.getElementById('riskFactors');
            const riskScore = riskData?.risk_score || 0;
            
            riskFactors.innerHTML = `
                <div class="mb-4">
                    <div class="text-2xl font-bold ${getRiskTextClass(riskScore)}">
                        Risk Score: ${riskScore}/100
                    </div>
                    <div class="text-sm text-gray-500">
                        Risk Level: ${getRiskLabel(riskScore)}
                    </div>
                </div>
                ${generateRiskFactors(riskData)}
            `;
        }

        function updateTransactionPatterns(tx) {
            const patterns = document.getElementById('patterns');
            patterns.innerHTML = `
                <div class="grid gap-4">
                    <div class="p-4 bg-gray-50 rounded">
                        <h3 class="font-medium">Transaction Type</h3>
                        <p class="text-sm text-gray-600 mt-1">${tx.type || 'Unknown'}</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <h3 class="font-medium">Volume Category</h3>
                        <p class="text-sm text-gray-600 mt-1">${categorizeVolume(tx.amount)}</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <h3 class="font-medium">Processing Speed</h3>
                        <p class="text-sm text-gray-600 mt-1">Standard</p>
                    </div>
                </div>
            `;
        }

        // Utility Functions
        function generateRiskFactors(riskData) {
            const defaultFactors = [
                'Transaction volume analysis',
                'Network pattern evaluation',
                'Historical behavior assessment'
            ];

            const factors = riskData?.factors || defaultFactors;
            return factors.map(factor => `
                <div class="p-3 bg-gray-50 rounded flex items-center">
                    <div class="w-2 h-2 rounded-full ${getRiskClass(riskData?.risk_score || 0)} mr-3"></div>
                    <span class="text-sm">${factor}</span>
                </div>
            `).join('');
        }

        function categorizeVolume(amount) {
            const value = parseFloat(amount) || 0;
            if (value === 0) return 'No transfer';
            if (value < 100) return 'Small transaction';
            if (value < 1000) return 'Medium transaction';
            return 'Large transaction';
        }

        function truncateAddress(address) {
            if (!address) return 'Unknown';
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        function getRiskClass(risk) {
            if (risk < 30) return 'bg-green-500';
            if (risk < 70) return 'bg-yellow-500';
            return 'bg-red-500';
        }

        function getRiskLabel(risk) {
            if (risk < 30) return 'Low Risk';
            if (risk < 70) return 'Medium Risk';
            return 'High Risk';
        }

        function getRiskTextClass(risk) {
            if (risk < 30) return 'text-green-600';
            if (risk < 70) return 'text-yellow-600';
            return 'text-red-600';
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showResults() {
            document.getElementById('resultsContainer').classList.remove('hidden');
        }

        function hideResults() {
            document.getElementById('resultsContainer').classList.add('hidden');
        }
    </script>
</body>
</html>